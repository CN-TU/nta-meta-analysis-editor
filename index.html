<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Paper editor</title>

    <!-- Bootstrap -->
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 70px;
        }
    </style>
  </head>
  <body>
  <nav class="navbar navbar-fixed-top navbar-default">
      <div class="container">
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <div class="btn-toolbar" role="toolbar">
                <button id="file-new" class="btn btn-default navbar-btn"><span class="glyphicon glyphicon-file"></span> New</button>
                <button id="file-open" class="btn btn-default navbar-btn"><span class="glyphicon glyphicon-folder-open"></span> Open</button>
                <button id="file-save" class="btn btn-default navbar-btn"><span class="glyphicon glyphicon-floppy-disk"></span> Save</button>
                <button id="file-save-as" class="btn btn-default navbar-btn"><span class="glyphicon glyphicon-floppy-save"></span> Save as...</button>
            </div>
          </ul>
          <p class="navbar-text navbar-right">Currently editing <span id="filename">unnamed file</span> <span class="label label-danger hidden" id="filechanged">modified</span></p>
        </div>
      </div>
    </nav>

    <div class="modal" id="working" tabindex="-1" role="dialog" aria-labelledby="Working...">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Working...</h4>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar active progress-bar-striped" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%;">
                            <span class="sr-only">Working...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container" role="main">
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#gui" aria-controls="gui" role="tab" data-toggle="tab">GUI</a></li>
            <li role="presentation"><a href="#raw" aria-controls="raw" role="tab" data-toggle="tab">Raw</a></li>
        </ul>
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="gui">
                <p><div id="editor_holder"></div></p>
            </div>
            <div role="tabpanel" class="tab-pane" id="raw">
                <p><textarea id="rawjson" class="form-control" rows="25"></textarea></p>
            </div>
        </div>
    </div>

    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/json-editor/dist/jsoneditor.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <script>
        const fs = require('fs')
        const path = require('path')
        const dialog = require('electron').remote.dialog

        JSONEditor.defaults.editors.object.options.collapsed = true
        JSONEditor.defaults.editors.object.options.remove_empty_properties = false

        var fileChanged = false
        var loading = false;
        var filename = null
        var schema = JSON.parse(fs.readFileSync(path.join(__dirname, 'schema_v2.json'), 'utf8'))
        var editor = null

        function somethingChanged() {
            if (loading) {
                loading = false;
                return;
            }
            fileChanged = true;
            $('#filechanged').removeClass("hidden");
        }
        function noChange() {
            fileChanged = false;
            $('#filechanged').addClass("hidden");
        }
        function neweditor(data) {
            if (editor !== null) {
                editor.destroy();
            }
            editor = new JSONEditor(document.getElementById('editor_holder'), {
                    startval: data,
                    schema: schema,
                    theme: 'bootstrap3',
                    iconlib: 'bootstrap3',
                    });
            loading = true;
            editor.on('change', somethingChanged);
            noChange();
            $('#rawjson').val(JSON.stringify(editor.getValue(), null, 2));
        }
        function setFilename(file) {
            filename = file;
            if (file == null) {
                $('#filename').html("unnamed file");
            } else {
                $('#filename').html("<mark>"+filename.split(path.sep).slice(-2).join(path.sep)+"</mark>");
            }
        }
        function fileNew() {
            neweditor();
            setFilename(null);
        }
        function canChange(fun) {
            if(fileChanged) {
                result = dialog.showMessageBox({
                        "type": "warning",
                        "title": "Unsaved changes",
                        "message": "You have unsaved changes, which will be lost if you continue. Do you want to continue?",
                        "buttons": ["Yes", "Cancel"],
                        "defaultId": 1,
                        "cancelId": 1
                })
                if (result == 0) {
                    fun();
                }
            } else {
                fun();
            }
        }
        function working(fun) {
            $('#working').modal();
            setTimeout(function(){
                fun()
                $('#working').modal('hide');
            }, 10);
        }
        function fileOpen() {
            files = dialog.showOpenDialog({
                    "title": "Open paper",
                    "filters": [
                        {name: 'JSON', extensions: ['json']}
                    ],
                    "properties": ["openFile"]})
            if (files !== undefined) {
                working(function() {
                    setFilename(files[0])
                    neweditor(JSON.parse(fs.readFileSync(files[0], 'utf8'))) //errorhandling!
                    noChange()
                })
            }
        }
        function fileSave() {
            if (filename == null) {
                return;
            }
            working(function() {
                fs.writeFileSync(filename, JSON.stringify(editor.getValue(), null, 2), {
                    "encoding": "utf8"
                })
                noChange()
            })
        }
        function fileSaveAs() {
            file = dialog.showSaveDialog({
                    "title": "Save paper as",
                    "filters": [
                        {name: 'JSON', extensions: ['json']}
                    ]})
            if (file !== undefined) {
                setFilename(file)
                fileSave()
            }
        }

        $('#file-new').click(function() {
            canChange(fileNew);
        });
        $('#file-open').click(function() {
            canChange(fileOpen);
        });
        $('#file-save').click(function() {
            if (filename == null) {
                fileSaveAs();
            } else {
                fileSave();
            }
        });
        $('#file-save-as').click(function() {
            fileSaveAs();
        });

        $('a[href="#raw"]').on('show.bs.tab', function () {
            $('#rawjson').val(JSON.stringify(editor.getValue(), null, 2));
        });
        $('a[href="#gui"]').on('show.bs.tab', function () {
            editor.setValue(JSON.parse($('#rawjson').val()));
        });
        $('#rawjson').bind('input propertychange', function() {
            somethingChanged();
        });

        fileNew()
    </script>
  </body>
</html>
