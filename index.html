<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Paper editor</title>

    <!-- Bootstrap -->
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 70px;
        }
        span.titlehelp > a {
            font-size: 14px;
            font-weight: 100;
        }
        button#feature_editor_button {
            margin-left: 6px;
        }
    </style>
  </head>
  <body>
  <nav class="navbar navbar-fixed-top navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav">
            <li>
            <div class="btn-toolbar" role="toolbar">
                <button id="file-new" class="btn btn-default navbar-btn"><span class="glyphicon glyphicon-file"></span> New</button>
                <button id="file-open" class="btn btn-default navbar-btn"><span class="glyphicon glyphicon-folder-open"></span> Open</button>
                <button id="file-save" class="btn btn-default navbar-btn"><span class="glyphicon glyphicon-floppy-disk"></span> Save</button>
                <button id="file-save-as" class="btn btn-default navbar-btn"><span class="glyphicon glyphicon-floppy-save"></span> Save as...</button>
            </div>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="navbar-text">Currently editing <span id="filename">unnamed file</span> <span class="label label-danger hidden" id="filechanged">modified</span></li>
         </ul>
        </div>
    </div>
  </nav>
    <div class="container-fluid" role="main">
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#gui" aria-controls="gui" role="tab" data-toggle="tab">GUI</a></li>
            <li role="presentation"><a href="#raw" aria-controls="raw" role="tab" data-toggle="tab">Raw</a></li>
        </ul>
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="gui">
                <p><div id="editor_holder"></div></p>
            </div>
            <div role="tabpanel" class="tab-pane" id="raw">
                <p><textarea id="rawjson" class="form-control" rows="25"></textarea></p>
            </div>
        </div>
    </div>

    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/json-editor/dist/jsoneditor.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <script>
        const fs = require('fs')
        const path = require('path')
        const dialog = require('electron').remote.dialog
        const {ipcRenderer} = require('electron')
        const {remote} = require('electron')
        const {ntarc_base_path} = remote.getCurrentWindow();

        JSONEditor.defaults.options.show_errors = 'always'
        JSONEditor.defaults.editors.object.options.collapsed = true
        JSONEditor.defaults.editors.object.options.remove_empty_properties = false

        var fileChanged = false
        var loading = false;
        var filename = null
        var schema = JSON.parse(fs.readFileSync(path.join(ntarc_base_path, 'schema_v2.json'), 'utf8'))
        var editor = null

        function featuresChanged(context) {
            let ctx = editor.getEditor('root.preprocessing.'+context);
            if (ctx === undefined || ctx === null) return;
            for(let row of ctx.rows) {
                let subeditor = editor.getEditor(row.path+'.features');
                if(subeditor.switcher.nextSibling.id == "feature_editor_button")
                    continue;
                let btn = document.createElement('button');
                btn.classList.add('btn', 'btn-default');
                btn.id = "feature_editor_button";
                btn.textContent = "Feature Editor";
                btn.onclick = function() {
                    if (subeditor.getValue() === null) {
                        subeditor.setValue([]);
                    }
                    ipcRenderer.send('launchEditor', remote.getCurrentWindow().id, subeditor.path, JSON.stringify(subeditor.getValue()), context);
                }
                subeditor.switcher.after(btn);
            }
        }
        ipcRenderer.on('change-feature', (event, which, feature) => {
            let elem = editor.getEditor(which)
            console.log(JSON.stringify(elem.getValue()), feature);
            if (JSON.stringify(elem.getValue()) != feature)
                elem.setValue(JSON.parse(feature));
        });

        function somethingChanged() {
            if (loading) {
                loading = false;
                return;
            }
            fileChanged = true;
            $('#filechanged').removeClass("hidden");
        }
        function noChange() {
            fileChanged = false;
            $('#filechanged').addClass("hidden");
        }
        function neweditor(data) {
            if (editor !== null) {
                editor.destroy();
            }
            editor = new JSONEditor(document.getElementById('editor_holder'), {
                    startval: data,
                    schema: schema,
                    theme: 'bootstrap3',
                    iconlib: 'bootstrap3',
                    });
            for(let context of ["packets", "flows", "flow_aggregations"]) {
                featuresChanged(context);
                editor.watch('root.preprocessing.'+context, function() { featuresChanged(context); });
            }
            loading = true;
            editor.on('change', somethingChanged);
            noChange();
            $('#rawjson').val(JSON.stringify(editor.getValue(), null, 2));
        }
        function setFilename(file) {
            filename = file;
            if (file == null) {
                $('#filename').html("unnamed file");
                document.title = "Paper editor - No File";
            } else {
                $('#filename').html("<mark>"+filename.split(path.sep).slice(-2).join(path.sep)+"</mark>");
                document.title = "Paper editor - editing "+filename.split(path.sep).slice(-2).join(path.sep);
            }
        }
        function fileNew() {
            ipcRenderer.send("fileNew")
        }
        function fileOpen() {
            files = dialog.showOpenDialog({
                    "title": "Open paper",
                    "filters": [
                        {name: 'JSON', extensions: ['json']}
                    ],
                    "properties": ["openFile"]})
            if (files !== undefined) {
                if ((filename === null) && !fileChanged) {
                    setFilename(files[0])
                    neweditor(JSON.parse(fs.readFileSync(files[0], 'utf8'))) //errorhandling!
                    noChange()
                } else {
                    ipcRenderer.send("fileOpen", files[0])
                }
            }
        }
        function fileSave() {
            if (filename == null) {
                return;
            }
            fs.writeFileSync(filename, JSON.stringify(editor.getValue(), null, 2), {
                "encoding": "utf8"
            })
            noChange()
        }
        function fileSaveAs() {
            file = dialog.showSaveDialog({
                    "title": "Save paper as",
                    "filters": [
                        {name: 'JSON', extensions: ['json']}
                    ]})
            if (file !== undefined) {
                setFilename(file)
                fileSave()
            }
        }

        let closeWindow = false

        window.onbeforeunload = (e) => {
            if (closeWindow) return
            if (!fileChanged) return
            e.returnValue = false

            setTimeout(() => {
                result = dialog.showMessageBox({
                        "type": "warning",
                        "title": "Unsaved changes",
                        "message": "You have unsaved changes, which will be lost if you close the window. Do you still want to close it?",
                        "buttons": ["Close", "Cancel"],
                        "defaultId": 1,
                        "cancelId": 1
                })
                if (result == 0) {
                    closeWindow = true
                    remote.getCurrentWindow().close()
                }
            })
        }
        ipcRenderer.on('new', fileNew)
        $('#file-new').click(fileNew)
        ipcRenderer.on('open', fileOpen)
        $('#file-open').click(fileOpen)
        ipcRenderer.on('save', () => {
            if (filename == null) {
                fileSaveAs();
            } else {
                fileSave();
            }
        })
        $('#file-save').click(() => {
            if (filename == null) {
                fileSaveAs();
            } else {
                fileSave();
            }
        });
        $('#file-save-as').click(fileSaveAs);
        ipcRenderer.on('save-as', fileSaveAs);

        $('a[href="#raw"]').on('show.bs.tab', () => {
            $('#rawjson').val(JSON.stringify(editor.getValue(), null, 2));
        });
        $('a[href="#gui"]').on('show.bs.tab', () => {
            editor.setValue(JSON.parse($('#rawjson').val()));
        });
        $('#rawjson').bind('input propertychange', () => {
            somethingChanged();
        });

        if (window.location.search != "") {
            filename = window.location.search.substr(1)
            setFilename(filename)
            neweditor(JSON.parse(fs.readFileSync(filename, 'utf8'))) //errorhandling!
            noChange()
        } else {
            neweditor();
            setFilename(null);
        }
    </script>
  </body>
</html>
