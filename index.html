<!DOCTYPE html>
<html>
    <head>
        <style>
          .ntarc_warning {
            border-bottom: 2px dashed orange;
            position: absolute;
          }
          .ntarc_error {
            border-bottom: 3px solid red;
            position: absolute;
          }
        </style>
    </head>
    <body>
        <button id="text">Text-Mode</button><button id="ntarc">JSON-Mode</button><br>
        <div id="input" style="height: 200px">count(quantile_range(octetTotalCount / _flowDurationSeconds, 0.05, 0.1));</div><br>
        <script src="node_modules/ace-builds/src-noconflict/ace.js"></script>
        <script src="node_modules/ace-builds/src-noconflict/ext-language_tools.js"></script>
        <script src="mode-ntarc-feature.js"></script>
        <script>
          var context = "flows";

          var result = document.getElementById("result");
          var editor = ace.edit("input");
          editor.setOptions({
            enableBasicAutocompletion: true,
            enableLiveAutocompletion: true
          });
          editor.setShowPrintMargin(false);

          var EditSession = ace.require('ace/edit_session').EditSession;

          var textSession = new EditSession("");
          textSession.$ntarc_context = context;
          textSession.setMode('ntarc-feature');

          editor.setSession(textSession);

          var ntarcSession = new EditSession("");
          ntarcSession.setMode('ace/mode/json');


          const {feature2text, text2feature} = require('./features.js');

          var mode="text";

          document.getElementById('text').onclick = () => {
            if(mode=="text")
              return;
            try {
              textSession.setValue(JSON.parse(ntarcSession.getValue()).map(feature => { return feature2text(feature);}).join(";\n"));
            } catch(e) {
              alert("Invalid JSON");
              return;
            }
            editor.setSession(textSession);
            mode = "text";
          };
          document.getElementById('ntarc').onclick = () => {
            if(mode=="ntarc")
              return;
            try {
              ntarcSession.setValue(JSON.stringify(textSession.getValue().split(';').map(feature => { return text2feature(feature, [], context);}).filter(feature => { return feature!==null;}), null, 2));
            } catch(e) {
              alert("Invalid Text");
              return;
            }
            editor.setSession(ntarcSession);
            mode = "ntarc";
          };
      </script>
    </body>
</html>