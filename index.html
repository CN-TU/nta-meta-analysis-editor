<!DOCTYPE html>
<html>
    <head>
        <style>
          .bad {
            border-bottom: 1px dashed green;
            position: absolute;
            cursor: pointer !important;
            pointer-events: auto;
          }
        </style>
    </head>
    <body>
        <div id="input" style="height: 200px">count(quantile_range(octetTotalCount / _flowDurationSeconds, 0.05, 0.1));</div><br>
        <textarea id="result"rows=30 cols=100></textarea>
        <script>
          require('ace-builds/src/ace');
          require("ace-builds/src/ext-language_tools");
          var editor = ace.edit("input", {mode: 'ntarc-feature'});
          editor.setOptions({
            enableBasicAutocompletion: true,
            enableLiveAutocompletion: true
          });
          editor.setShowPrintMargin(false);
          var Range = require('ace/range').Range;

          var result = document.getElementById("result");

          const {feature2text, text2feature} = require('./features.js');

          var oldInput;
          var parseTimer;
          function parse() {
            try {
              oldInput = editor.getValue();
              let features = oldInput.split(';');
              let errors = [];
              let obj = features.map(function(f) { return text2feature(f, errors);});
              result.value = JSON.stringify(obj, null, 2);
              console.log(errors);
              let gutter = [];
              for(let i=0; i<errors.length; i++) {
                gutter.push({
                  row: errors[i].location.start.line-1,
                  column: errors[i].location.start.column-1,
                  text: errors[i].error,
                  type: "warning"
                })
                editor.getSession().addMarker(new Range(errors[i].location.start.line-1, errors[i].location.start.column-1, errors[i].location.end.line-1, errors[i].location.end.column-1), "bad", "text");
              }
              editor.getSession().setAnnotations(gutter);
            } catch(e) {
              console.log(e);
              result.value = "In line "+ e.location.start.line + " column "+ e.location.start.column + ": " + e.message;
            }
          }
          function scheduleParse() {
            if (editor.getValue() === oldInput) { return; }
            if (parseTimer !== null) {
              clearTimeout(parseTimer);
              parseTimer = null;
            }

            parseTimer = setTimeout(function() {
              parse();
              parseTimer = null;
            }, 500);
          }
          editor.getSession().on('change', scheduleParse);
          parse();
      </script>
    </body>
</html>