<!DOCTYPE html>
<html lang="en">
<html>
    <head>
        <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          .ntarc_warning {
            border-bottom: 2px dashed orange;
            position: absolute;
          }
          .ntarc_error {
            border-bottom: 3px solid red;
            position: absolute;
          }
          .bottom {
            padding: 2px;
            border-top: 1px solid #ddd;
          }
          body {
            margin-top: 1px;
          }
          #input {
            flex-grow: 1;
          }
          .window {
            position: absolute;
            left: 0px;
            right: 0px;
            bottom: 0px;
            top: 0px;
            display: flex;
            flex: auto;
            flex-direction: column;
          }
          .right {
            position: absolute;
            right: 2px;
          }
        </style>
    </head>
    <body>
        <div class="window">
          <div>
            <ul class="nav nav-tabs">
              <li role="presentation" class="active"><a href="#" id="text">Text-Mode</a></li>
              <li role="presentation"><a href="#" id="ntarc">JSON-Mode</a></li>
            </ul>
          </div>
          <div id="input"></div>
          <div class="bottom">
            <button id="ok" class="btn btn-primary"><span class="glyphicon glyphicon-ok"></span> Finished</button>
            <button id="cancel" class="btn btn-default right"><span class="glyphicon glyphicon-remove"></span> Cancel</button>
          </div>
        </div>
        <script src="node_modules/ace-builds/src-noconflict/ace.js"></script>
        <script src="node_modules/ace-builds/src-noconflict/ext-language_tools.js"></script>
        <script src="mode-ntarc-feature.js"></script>
        <script>
          const {remote, ipcRenderer} = require('electron');
          const {ntarc_feature, ntarc_context, ntarc_base_path, ntarc_id, ntarc_which} = remote.getCurrentWindow();
          const {feature2text, text2feature} = require('./features.js')(ntarc_base_path);
          const dialog = require('electron').remote.dialog

          var result = document.getElementById("result");
          var editor = ace.edit("input");
          editor.setOptions({
            enableBasicAutocompletion: true,
            enableLiveAutocompletion: true
          });
          editor.setShowPrintMargin(false);

          var EditSession = ace.require('ace/edit_session').EditSession;

          var textSession = new EditSession("");

          require('./mode-ntarc-feature.js')(ntarc_base_path, ntarc_context); //this is a bit hacky - but I don't know a better way :(
          var ntarcMode = ace.require('ntarc-feature').Mode;
          textSession.setMode(new ntarcMode());

          textSession.setValue(JSON.parse(ntarc_feature).map(feature => { return feature2text(feature);}).join(";\n"));

          editor.setSession(textSession);

          var ntarcSession = new EditSession("");
          ntarcSession.setMode('ace/mode/json');

          var mode="text";

          var ntarc_button = document.getElementById('ntarc');
          var text_button = document.getElementById('text');

          text_button.onclick = () => {
            if(mode=="text")
              return;
            try {
              textSession.setValue(JSON.parse(ntarcSession.getValue()).map(feature => { return feature2text(feature);}).join(";\n"));
            } catch(e) {
              alert("Invalid JSON");
              return;
            }
            editor.setSession(textSession);
            mode = "text";
            text_button.parentElement.classList.add('active');
            ntarc_button.parentElement.classList.remove('active');
          };
          ntarc_button.onclick = () => {
            if(mode=="ntarc")
              return;
            try {
              ntarcSession.setValue(JSON.stringify(textSession.getValue().split(';').map(feature => { return text2feature(feature, [], ntarc_context);}).filter(feature => { return feature!==null;}), null, 2));
            } catch(e) {
              console.log(e);
              alert("Invalid Text");
              return;
            }
            editor.setSession(ntarcSession);
            mode = "ntarc";
            text_button.parentElement.classList.remove('active');
            ntarc_button.parentElement.classList.add('active');
          };
          document.getElementById('ok').onclick = () => {
            let ret;
            try {
              ret = JSON.stringify(textSession.getValue().split(';').map(feature => { return text2feature(feature, [], ntarc_context);}).filter(feature => { return feature!==null;}));
            } catch(e) {
              console.log(e);
              alert("Invalid Text");
              return;
            }
            ipcRenderer.send('editorResult', ntarc_id, ntarc_which, ret);
            remote.getCurrentWindow().close();
          };
          document.getElementById('cancel').onclick = () => {
            let ret = JSON.stringify(textSession.getValue().split(';').map(feature => { return text2feature(feature, [], ntarc_context);}).filter(feature => { return feature!==null;}));
            if(ret != ntarc_feature) {
              result = dialog.showMessageBox({
                        "type": "warning",
                        "title": "Changed features",
                        "message": "You have changed the features. Do you still want to cancel?",
                        "buttons": ["Cancel", "No"],
                        "defaultId": 1,
                        "cancelId": 1
                })
                if (result == 0) {
                    remote.getCurrentWindow().close()
                }
            } else {
              remote.getCurrentWindow().close();
            }
          };
      </script>
    </body>
</html>

